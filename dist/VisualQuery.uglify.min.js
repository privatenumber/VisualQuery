/*! VisualQuery 2014-05-21 */
!function(a){a.fn.focus=function(a,b){"use strict";if(this[0]){if(arguments.length>=1&&Array.prototype.every.call(arguments,function(a){return Math.floor(a)===a})){if(this[0].setSelectionRange)try{return this[0].setSelectionRange(a,b||a)}catch(c){return this.trigger("focus")}else if(this[0].createTextRange){var d=this[0].createTextRange();d.collapse(!0),d.moveEnd("character",b||a),d.moveStart("character",a),d.select()}}else if(2===arguments.length)return this.on("focus",null,a,b);return this.trigger("focus")}},a.fn.visualquery=function(b){"use strict";b=a.extend({strict:!1,parameters:[],defaultQuery:[],placeholder:"",callback:a.noop()},b);var c=function(){b.callback(f.list.map(function(a){return a.validate()&&{name:a.name.val(),operator:h[a.name.val()+"_operators"]&&h[a.name.val()+"_operators"][a.operator.val()]||a.operator.val(),value:h[a.name.val()+"_values"]&&h[a.name.val()+"_values"][a.value.val()]||a.value.val()}}).filter(function(a){return a}))},d=a("<div></div>",{"class":"placeholder",style:"pointer-events: none;"+(b.defaultQuery.length?"display:none":""),text:b.placeholder}),e=a("<div>",{"class":"parameters",html:d}).on({focusin:function(){e.addClass("selected")},focusout:function(){e.removeClass("selected")},mousedown:function(b){if(a(b.target).is(e)){b.preventDefault(),a("div.parameter.selected",e).removeClass("selected");var c;a("div.parameter",e).each(function(){var d=a(this),e=d.offset();return e.top>b.pageY||e.top<b.pageY&&b.pageY<e.top+d.height()&&e.left>b.pageX?!1:void(c=d)});var d=new l;d.$[void 0!==c?"insertAfter":"prependTo"](c||this),d.name.focus(),f.update()}}}),f={list:[],update:function(){var b=this,c=e.children("div.parameter");return this.list=[],d[c.length?"hide":"show"](),c.each(function(){b.list.push(a(this).data("Parameter"))}),this}},g={},h={names:[]};b.parameters.forEach(function(a){g[a.name]=a,h.names.push(a.name),h[a.name+"_operators"]=a.operators&&a.operators,h[a.name+"_values"]=a.values&&a.values});var i=function(){var b,c,d,e=a("<ul>",{"class":"autoComplete"}).css({position:"absolute",display:"none"}).on("mouseover","li",function(){var c=a(this).addClass("selected");c.siblings(".selected").removeClass("selected"),b.attr("placeholder",c.attr("value")).trigger("adjustWidth")}).on("mousedown","li",function(c){c.preventDefault(),b.removeAttr("placeholder").val(a(this).attr("value")).trigger("input").blur().next().focus()}),f=function(){console.log(e);var f=e.children(".selected"),g=-1!==f.index()?f:0,h=c.map(function(c,d){return c.match(new RegExp(b.val(),"i"))?a("<li>",{text:c,"class":g===d?b.attr("placeholder",c).trigger("adjustWidth")&&"selected":""}).attr("value",c):void 0}).filter(function(a){return a});return d=d||parseInt(e.find("li").css("padding-left")),h.length?e.html(h).show():e.hide()};return{$:e,targetInput:function(c){return(b=a(c).on({input:f.bind(this),blur:function(){a(this).unbind("keydown input")},keydown:function(b){var c,d=a(this);if(13===b.keyCode&&(b.preventDefault(),b=e.is(":visible")&&1===(c=e.children(".selected")).length&&d.val(c.attr("value")).trigger("input"),d.blur().next().focus()),e.is(":visible")&&(40===b.keyCode||38===b.keyCode)){b.preventDefault();var f=40===b.keyCode?"next":"prev";return(c=e.children(".selected"))[f]().length&&(c=c.removeClass("selected")[f]().addClass("selected"))&&d.attr("placeholder",c.attr("value")).trigger("adjustWidth")}}}))&&this},setLis:function(b){return(c=a.isArray(b)?b:Object.keys(b))&&f()&&this},show:function(a){0!==c.length&&e.show().offset({top:a.top+b.height(),left:a.left-(d||0)})}}}(),j=function(a){try{return 0===a.selectionStart&&0===a.selectionEnd}catch(b){return!1}},k=function(a,b){try{return a.val().length===b.selectionStart&&a.val().length===b.selectionEnd}catch(c){return!1}},l=function(d,l,m){var n=this;this.remove=function(){n.$.remove(),f.update(),c()},this.validate=function(){var a=n.name.val(),c=n.operator.val(),d=n.value.val();return(a+c+d).length?a.length&&c.length&&d.length?b.strict&&!g.hasOwnProperty(a)?n.$.addClass("error").attr("title","Invalid Parameter")&&!1:n.value[0].checkValidity()?!0:n.$.addClass("error").attr("title",n.value[0].validationMessage)&&!1:(n.$.addClass("error"),!1):n.remove()&&!1},this.$=a("<div>",{"class":"parameter"}).data("Parameter",this).append(a("<span></span>",{id:"remove",html:"&times;"}).on("click",n.remove),this.name=a("<input>",{type:"text",spellcheck:"false",autoComplete:"off",id:"name",value:d,style:"width:1px;"}).on({focus:function(){i.setLis(h.names).show(a(this).offset())},blur:function(){var a=n.name.val(),b=g[a]||{};n.operator.attr(jQuery.extend({placeholder:""},b.operatorAttrs||{},{type:"text"})).trigger("input"),n.value.attr(jQuery.extend({placeholder:""},b.valueAttrs||{},{type:-1!==["text","email","number","url"].indexOf(b.type)&&b.type||"text"})).trigger("input")}}),this.operator=a("<input>",{type:"text",spellcheck:"false",autoComplete:"off",id:"operator",value:l,style:"width:1px;"}).on("focus",function(){i.setLis(h[n.name.val()+"_operators"]||[]).show(a(this).offset())}),this.value=a("<input>",{type:"text",spellcheck:"false",autoComplete:"off",id:"value",value:m,style:"width:10px;"}).on("focus",function(){i.setLis(h[n.name.val()+"_values"]||[]).show(a(this).offset())})).on("keydown","input#name",function(a){if(j(this)&&37===a.keyCode){a.preventDefault();var b=f.list[f.list.indexOf(n)-1];b=b&&b.value.focus()}}).on("keydown","input#value",function(b){if(k(a(this),this)&&39===b.keyCode){b.preventDefault();var c=f.list[f.list.indexOf(n)+1];c=c&&c.name.focus(0)}}).on({keydown:function(b){var c=a(this);k(c,this)&&39===b.keyCode&&(b.preventDefault(),c.next().focus(0)),!j(this)||37!==b.keyCode&&8!==b.keyCode||(b.preventDefault(),c.prev().focus())},blur:function(){n.$.removeClass("selected"),n.validate(),i.$.hide(),c()},focus:function(){n.$.removeClass("error").addClass("selected"),i.targetInput(this)},"input adjustWidth":function(){var c={number:17},d=a(this),f=d.val(),g=0!==f.length?f:d.attr("placeholder")||"",h=a("<span>",{"class":b["class"]}).css(jQuery.extend({position:"absolute",width:"auto",visibility:"hidden",whiteSpace:"pre"},d.css(["font-size","font-family","font-weight","font-style","font-variant","word-spacing","letter-spacing","text-indent","text-rendering","text-transform"]))).text(g).appendTo(e),i=h.width();h.remove(),d.width((i||10)+1+(c[d.attr("type")]||0))}},"input")};this.html([e,i.$]),b.defaultQuery.forEach(function(a){(!b.strict||a.name in g)&&(a=new l(a.name,a.operator,a.value,a.type),a.$.appendTo(e),a.name.trigger("blur").trigger("adjustWidth"),a.operator.trigger("adjustWidth"),a.value.trigger("adjustWidth"),f.update())}),c()}}(window.jQuery);