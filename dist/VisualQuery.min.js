$.fn.focus=function(b,h){if(this[0]){if(1<=arguments.length&&Array.prototype.every.call(arguments,function(b){return Math.floor(b)===b}))if(this[0].setSelectionRange)try{return this[0].setSelectionRange(b,h||b)}catch(l){}else{if(this[0].createTextRange){var f=this[0].createTextRange();f.collapse(!0);f.moveEnd("character",h||b);f.moveStart("character",b);f.select()}}else if(2===arguments.length)return this.on("focus",null,b,h);return this.trigger("focus")}};
$.fn.visualquery=function(b){b=$.extend({strict:!1,parameters:[],defaultQuery:[],placeholder:"",callback:$.noop()},b);var h=function(){b.callback(g.list.map(function(a){return a.validate()&&{name:a.name.val(),operator:e[a.name.val()+"_operators"]&&e[a.name.val()+"_operators"][a.operator.val()]||a.operator.val(),value:e[a.name.val()+"_values"]&&e[a.name.val()+"_values"][a.value.val()]||a.value.val()}}).filter(function(a){return a}))},l=$("<div></div>",{"class":"placeholder",text:b.placeholder,style:"pointer-events: none; display:none;"}),
f=$("<div>",{"class":"parameters",html:l}).on({focusin:function(){f.addClass("selected")},focusout:function(){f.removeClass("selected")},mousedown:function(a){if($(a.target).is(f)){a.preventDefault();$("div.parameter.selected",f).removeClass("selected");var b;$("div.parameter",f).each(function(){var c=$(this),d=c.offset();if(d.top>a.pageY||d.top<a.pageY&&a.pageY<d.top+c.height()&&d.left>a.pageX)return!1;b=c});var e=new n;e.$[void 0!==b?"insertAfter":"prependTo"](b||this);e.name.focus();g.update()}}}),
g={list:[],update:function(){var a=this,b=f.children("div.parameter");this.list=[];l[b.length?"hide":"show"]();b.each(function(){a.list.push($(this).data("Parameter"))});return this}},p={},e={names:[]};b.parameters.forEach(function(a){p[a.name]=a;e.names.push(a.name);e[a.name+"_operators"]=a.operators&&a.operators;e[a.name+"_values"]=a.values&&a.values});var m=function(){var a,b,e,c=$("<ul>",{"class":"autoComplete"}).css({position:"absolute",display:"none"}).on("mouseover","li",function(){var d=$(this).addClass("selected");
d.siblings(".selected").removeClass("selected");a.attr("placeholder",d.attr("value")).trigger("adjustWidth")}).on("mousedown","li",function(d){d.preventDefault();a.removeAttr("placeholder").val($(this).attr("value")).trigger("input").blur().next().focus()}),d=function(){var d=c.children(".selected").index(),s=-1!==d?d:0,d=b.map(function(d,c){if(d.match(new RegExp(a.val(),"i")))return $("<li>",{text:d,"class":s===c?a.attr("placeholder",d).trigger("adjustWidth")&&"selected":""}).attr("value",d)}).filter(function(a){return a});
e=e||parseInt(c.find("li").css("padding-left"));return d.length?c.html(d).show():c.hide()};return{$:c,targetInput:function(b){return(a=$(b).on({input:d.bind(this),blur:function(){$(this).unbind("keydown input")},keydown:function(a){var d=$(this),b;if(13===a.keyCode){a.preventDefault();a=c.is(":visible")&&1===(b=c.children(".selected")).length&&d.val(b.attr("value")).trigger("input");var k=d.blur().next();k.length?k.focus():((k=new n).$.appendTo(f),k.name.focus(),g.update())}if(c.is(":visible")&&(40===
a.keyCode||38===a.keyCode))return a.preventDefault(),a=40===a.keyCode?"next":"prev",(b=c.children(".selected"))[a]().length&&(b=b.removeClass("selected")[a]().addClass("selected"))&&d.attr("placeholder",b.attr("value")).trigger("adjustWidth")}}))&&this},setLis:function(a){return(b=$.isArray(a)?a:Object.keys(a))&&d()&&this},show:function(d){0!==b.length&&c.show().offset({top:d.top+a.height(),left:d.left-(e||0)})}}}(),q=function(a){try{return 0===a.selectionStart&&0===a.selectionEnd}catch(b){return!1}},
r=function(a,b){try{return a.val().length===b.selectionStart&&a.val().length===b.selectionEnd}catch(e){return!1}},n=function(a,l,n){var c=this;this.remove=function(){c.$.remove();g.update();h()};this.validate=function(){var a=c.name.val(),k=c.operator.val(),e=c.value.val();return(a+k+e).length?a.length&&k.length&&e.length?b.strict&&!p.hasOwnProperty(a)?c.$.addClass("error").attr("title","Invalid Parameter")&&!1:c.value[0].checkValidity()?!0:c.$.addClass("error").attr("title",c.value[0].validationMessage)&&
!1:(c.$.addClass("error"),!1):c.remove()&&!1};this.$=$("<div>",{"class":"parameter"}).data("Parameter",this).append($("<span></span>",{id:"remove",html:"&times;"}).on("click",c.remove),this.name=$("<input>",{type:"text",spellcheck:"false",autoComplete:"off",id:"name",value:a,style:"width:1px;"}).on({focus:function(){m.setLis(e.names).show($(this).offset())},blur:function(){var a=c.name.val(),a=p[a]||{};c.operator.attr(jQuery.extend({placeholder:""},a.operatorAttrs||{},{type:"text"})).trigger("input");
c.value.attr(jQuery.extend({placeholder:""},a.valueAttrs||{},{type:-1!==["text","email","number","url"].indexOf(a.type)&&a.type||"text"})).trigger("input")}}),this.operator=$("<input>",{type:"text",spellcheck:"false",autoComplete:"off",id:"operator",value:l,style:"width:1px;"}).on("focus",function(){m.setLis(e[c.name.val()+"_operators"]||[]).show($(this).offset())}),this.value=$("<input>",{type:"text",spellcheck:"false",autoComplete:"off",id:"value",value:n,style:"width:10px;"}).on("focus",function(){m.setLis(e[c.name.val()+
"_values"]||[]).show($(this).offset())})).on("keydown","input#name",function(a){q(this)&&37===a.keyCode&&(a.preventDefault(),(a=g.list[g.list.indexOf(c)-1])&&a.value.focus())}).on("keydown","input#value",function(a){r($(this),this)&&39===a.keyCode&&(a.preventDefault(),(a=g.list[g.list.indexOf(c)+1])&&a.name.focus(0))}).on({keydown:function(a){var b=$(this);r(b,this)&&39===a.keyCode&&(a.preventDefault(),b.next().focus(0));!q(this)||37!==a.keyCode&&8!==a.keyCode||(a.preventDefault(),b.prev().focus())},
blur:function(){c.$.removeClass("selected");c.validate();m.$.hide();h()},focus:function(){c.$.removeClass("error").addClass("selected");m.targetInput(this)},"input adjustWidth":function(){var a=$(this),c=a.val(),c=0!==c.length?c:a.attr("placeholder")||"",c=$("<span>",{"class":b["class"]}).css(jQuery.extend({position:"absolute",width:"auto",visibility:"hidden",whiteSpace:"pre"},a.css("font-size font-family font-weight font-style font-variant word-spacing letter-spacing text-indent text-rendering text-transform".split(" ")))).text(c).appendTo(f),
e=c.width();c.remove();a.width((e||10)+1+({number:17}[a.attr("type")]||0))}},"input")};this.html([f,m.$]);b.defaultQuery.filter(function(a){if(!b.strict||a.name in p)return a=new n(a.name,a.operator,a.value,a.type),a.$.appendTo(f),a.name.trigger("blur").trigger("adjustWidth"),a.operator.trigger("adjustWidth"),a.value.trigger("adjustWidth"),g.update(),!0}).length||l.show();h()};
